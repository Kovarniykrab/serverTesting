name: Deploy

on:
    workflow_dispatch:
    push:
        branches: [ "main", "ci/cd" ]

    pull_request:
        branches: [ "main", "ci/cd" ]

jobs:
     build:
        runs-on: ubuntu-latest
        steps:
        
        - uses: actions/checkout@v4

        - name: "Set up Go"
          uses: actions/setup-go@v4
          with:
            go-version: '1.24.5'

        - name: "Build"
          run: go build -v ./...

     deploy:
       name: Push Docker image to Docker Hub
       runs-on: ubuntu-latest
       needs: build
       steps:
         - name: Checkout
           uses: actions/checkout@v4

         - name: Set up Docker buildx
           uses: docker/setup-buildx-action@v3

         - name: Log in to Docker Hub
           uses: docker/login-action@v3
           with:
             username: ${{ secrets.DOCKER_USERNAME }}
             password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

         - name: Extract metadata (tags, labels) for Docker
           id: meta
           uses: docker/metadata-action@v5.5.1
           with:
             images: ${{ secrets.DOCKER_USERNAME }}/servertesting
                
         - name: Build and push Docker Image
           uses: docker/build-push-action@v5
           with:
             context: .
             file: ./Dockerfile
             platforms: linux/amd64,linux/arm64
             push: true
             tags: ${{ secrets.DOCKER_USERNAME }}/servertesting:latest
